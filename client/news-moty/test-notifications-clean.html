<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”” ×‘×“×™×§×ª ××¢×¨×›×ª ×”×ª×¨××•×ª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card { 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .btn { 
            margin: 5px; 
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #debug-info { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 10px;
            background: #f8f9fa;
        }
        .result-box {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            background: #f0f8ff;
            margin: 10px 0;
        }
        .emoji { font-size: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header text-center bg-primary text-white">
                    <h1>ğŸ”” ××¢×¨×›×ª ×”×ª×¨××•×ª - ××¨×›×– ×‘×“×™×§×•×ª ××ª×§×“×</h1>
                    <p class="mb-0">×›×œ ×”×›×œ×™× ×œ××‘×—×•×Ÿ ×•×ª×™×§×•×Ÿ ×‘×¢×™×•×ª Firebase Cloud Messaging</p>
                </div>
                
                <div class="card-body">
                    <!-- ×‘×“×™×§×•×ª Firebase ××ª×§×“××•×ª -->
                    <div class="mb-4">
                        <h5 class="text-primary">ğŸ” ×‘×“×™×§×•×ª Firebase ××ª×§×“××•×ª</h5>
                        <button class="btn btn-primary" onclick="runCompleteFirebaseCheck()">
                            <span class="emoji">ğŸ¯</span> ×‘×“×™×§×” ××œ××” ×©×œ Firebase
                        </button>
                        <button class="btn btn-info" onclick="fullFirebaseProjectCheck()">
                            <span class="emoji">ğŸ“‹</span> ×‘×“×™×§×ª ×”×’×“×¨×•×ª ×¤×¨×•×™×§×˜
                        </button>
                        <button class="btn btn-warning" onclick="checkServiceWorkerConfig()">
                            <span class="emoji">ğŸ”§</span> ×‘×“×™×§×ª Service Worker
                        </button>
                        <button class="btn btn-success" onclick="checkLocalServer()">
                            <span class="emoji">ğŸŒ</span> ×‘×“×™×§×ª ×©×¨×ª ××§×•××™
                        </button>
                    </div>

                    <!-- ×ª×•×¦××•×ª ×‘×“×™×§×•×ª -->
                    <div id="firebase-check-result" class="result-box" style="display: none;">
                        <h6>ğŸ“Š ×ª×•×¦××•×ª ×‘×“×™×§×•×ª:</h6>
                    </div>

                    <hr>

                    <!-- ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª -->
                    <div class="mb-4">
                        <h5 class="text-secondary">ğŸ§ª ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª</h5>
                        <button class="btn btn-outline-primary" onclick="testFirebaseConfig()">
                            <span class="emoji">âš™ï¸</span> ×‘×“×™×§×ª ×§×•× ×¤×™×’×•×¨×¦×™×”
                        </button>
                        <button class="btn btn-outline-secondary" onclick="testPermissions()">
                            <span class="emoji">ğŸ”’</span> ×‘×“×™×§×ª ×”×¨×©××•×ª
                        </button>
                        <button class="btn btn-outline-success" onclick="testGetToken()">
                            <span class="emoji">ğŸ”‘</span> ×§×‘×œ×ª FCM Token
                        </button>
                        <button class="btn btn-outline-warning" onclick="testSaveToken()">
                            <span class="emoji">ğŸ’¾</span> ×©××™×¨×ª Token
                        </button>
                        <button class="btn btn-outline-info" onclick="testServerConnection()">
                            <span class="emoji">ğŸ”—</span> ×—×™×‘×•×¨ ×œ×©×¨×ª
                        </button>
                    </div>

                    <hr>

                    <!-- ×©×—×–×•×¨ ××¢×¨×›×ª -->
                    <div class="mb-4">
                        <h5 class="text-success">ğŸ¥ ×©×—×–×•×¨ ××¢×¨×›×ª</h5>
                        <button class="btn btn-success" onclick="recoverNotificationSystem()">
                            <span class="emoji">ğŸ”„</span> ×©×—×–×•×¨ ××œ× ×©×œ ×”××¢×¨×›×ª
                        </button>
                        <button class="btn btn-info" onclick="showNotificationButtonImmediate()">
                            <span class="emoji">ğŸ””</span> ×”×¦×’×ª ×›×¤×ª×•×¨ ×¤×¢××•×Ÿ
                        </button>
                        <button class="btn btn-warning" onclick="if(window.currentUser) sendTestNotification(window.currentUser.id)">
                            <span class="emoji">ğŸ“§</span> ×©×œ×™×—×ª ×”×ª×¨××ª ×‘×“×™×§×”
                        </button>
                    </div>

                    <hr>

                    <!-- ×œ×•×’ ××¢×¨×›×ª -->
                    <div class="mb-4">
                        <h5 class="text-dark">ğŸ“‹ ×œ×•×’ ××¢×¨×›×ª</h5>
                        <div id="debug-info"></div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="clearDebugInfo()">
                                <span class="emoji">ğŸ—‘ï¸</span> × ×§×” ×œ×•×’
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyDebugInfo()">
                                <span class="emoji">ğŸ“‹</span> ×”×¢×ª×§ ×œ×•×’
                            </button>
                        </div>
                    </div>

                    <!-- ××™×“×¢ ××¢×¨×›×ª -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6>â„¹ï¸ ××™×“×¢ ××¢×¨×›×ª:</h6>
                        <small class="text-muted">
                            â€¢ Firebase SDK Version: 12.0.0<br>
                            â€¢ Service Worker: firebase-messaging-sw.js<br>
                            â€¢ Server: localhost:7065<br>
                            â€¢ Current User: <span id="current-user-info">×œ× ××•×’×“×¨</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ×›×œ ×”×¡×§×¨×™×¤×˜×™× ×”× ×“×¨×©×™× -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/shared/initServerUrl.js"></script>
<script src="js/shared/data.js"></script>
<script src="js/shared/ajaxCalls.js"></script>
<script src="js/firebaseConfig.js"></script>
<script src="js/notifications.js"></script>
<script src="js/notification-recovery.js"></script>
<script src="js/firebase-advanced-check.js"></script>

<script>
// ×”×’×“×¨×ª ××©×ª××© ×‘×“×™×§×”
window.currentUser = { id: 1, name: "Test User" };
document.getElementById('current-user-info').textContent = window.currentUser.name;

// ×¤×•× ×§×¦×™×™×ª ×œ×•×’ ××©×•×¤×¨×ª
function log(message, type = 'info') {
    const debugInfo = document.getElementById('debug-info');
    const timestamp = new Date().toLocaleTimeString('he-IL');
    const alertClass = {
        'info': 'alert-info',
        'success': 'alert-success', 
        'warning': 'alert-warning',
        'error': 'alert-danger'
    }[type] || 'alert-info';
    
    debugInfo.innerHTML += `<div class="alert ${alertClass} mb-1">
        <small class="text-muted">[${timestamp}]</small> ${message}
    </div>`;
    debugInfo.scrollTop = debugInfo.scrollHeight;
    console.log(`[${timestamp}] ${message}`);
}

// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
function clearDebugInfo() {
    document.getElementById('debug-info').innerHTML = '';
    log('×œ×•×’ × ×•×§×”', 'info');
}

function copyDebugInfo() {
    const debugInfo = document.getElementById('debug-info').innerText;
    navigator.clipboard.writeText(debugInfo).then(() => {
        log('×œ×•×’ ×”×•×¢×ª×§ ×œ×œ×•×—', 'success');
    });
}

// ×”×¦×’×ª ×ª×•×¦××•×ª ×‘×“×™×§×•×ª
function showCheckResults() {
    const resultDiv = document.getElementById('firebase-check-result');
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

// ××ª×—×•×œ Firebase ×œ×‘×“×™×§×•×ª
async function initFirebaseForTesting() {
    if (typeof firebaseConfig !== 'undefined') {
        try {
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js');
            window.app = initializeApp(firebaseConfig);
            log('Firebase ××•×ª×—×œ ×‘×”×¦×œ×—×” ×œ×‘×“×™×§×•×ª', 'success');
            return true;
        } catch (error) {
            log(`×©×’×™××” ×‘××ª×—×•×œ Firebase: ${error.message}`, 'error');
            return false;
        }
    } else {
        log('×§×•× ×¤×™×’×•×¨×¦×™×™×ª Firebase ×œ× × ××¦××”', 'error');
        return false;
    }
}

// ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×•×ª override ×œ×‘×“×™×§×•×ª ×—×“×©×•×ª
const originalRunCompleteCheck = window.runCompleteFirebaseCheck;
window.runCompleteFirebaseCheck = async function() {
    showCheckResults();
    log('××ª×—×™×œ ×‘×“×™×§×” ××œ××” ×©×œ Firebase...', 'info');
    const result = await originalRunCompleteCheck();
    if (result) {
        log('âœ… ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• ×‘×”×¦×œ×—×”!', 'success');
    } else {
        log('âŒ ×™×© ×‘×¢×™×•×ª ×©×¦×¨×™×›×•×ª ×ª×™×§×•×Ÿ', 'error');
    }
    return result;
};

const originalCheckServer = window.checkLocalServer;
window.checkLocalServer = async function() {
    showCheckResults();
    log('×‘×•×“×§ ×—×™×‘×•×¨ ×œ×©×¨×ª ××§×•××™...', 'info');
    const result = await originalCheckServer();
    if (result) {
        log('âœ… ×”×©×¨×ª ×¤×•×¢×œ ×ª×§×™×Ÿ', 'success');
    } else {
        log('âŒ ×‘×¢×™×” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
    }
    return result;
};

// ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×” ×‘×¡×™×¡×™×•×ª ××§×•×¨×™×•×ª
function testFirebaseConfig() {
    log('×‘×•×“×§ ×§×•× ×¤×™×’×•×¨×¦×™×™×ª Firebase...', 'info');
    if (typeof firebaseConfig !== 'undefined') {
        log(`âœ… Firebase config × ××¦× - ×¤×¨×•×™×§×˜: ${firebaseConfig.projectId}`, 'success');
    } else {
        log('âŒ Firebase config ×œ× × ××¦×', 'error');
    }
}

function testPermissions() {
    log('×‘×•×“×§ ×”×¨×©××•×ª ×“×¤×“×¤×Ÿ...', 'info');
    if ('Notification' in window) {
        const permission = Notification.permission;
        log(`×”×¨×©××ª ×”×ª×¨××•×ª: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        if (permission === 'default') {
            Notification.requestPermission().then(result => {
                log(`×ª×•×¦××ª ×‘×§×©×ª ×”×¨×©××”: ${result}`, result === 'granted' ? 'success' : 'error');
            });
        }
    } else {
        log('âŒ ×”×ª×¨××•×ª ×œ× × ×ª××›×•×ª ×‘×“×¤×“×¤×Ÿ ×–×”', 'error');
    }
}

async function testGetToken() {
    log('×× ×¡×” ×œ×§×‘×œ FCM token...', 'info');
    try {
        if (!window.app) {
            await initFirebaseForTesting();
        }
        
        const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-messaging.js');
        const messaging = getMessaging(window.app);
        
        if (typeof vapidKey !== 'undefined') {
            const token = await getToken(messaging, { vapidKey: vapidKey });
            if (token) {
                log(`âœ… FCM Token ×”×ª×§×‘×œ: ${token.substring(0, 30)}...`, 'success');
                window.lastGeneratedToken = token;
            } else {
                log('âŒ ×œ× ×”×ª×§×‘×œ FCM Token', 'error');
            }
        } else {
            log('âŒ VAPID Key ×œ× × ××¦×', 'error');
        }
    } catch (error) {
        log(`âŒ ×©×’×™××” ×‘×§×‘×œ×ª Token: ${error.message}`, 'error');
    }
}

async function testSaveToken() {
    if (!window.lastGeneratedToken) {
        log('×§×•×“× ×¦×¨×™×š ×œ×§×‘×œ Token', 'warning');
        await testGetToken();
    }
    
    if (window.lastGeneratedToken) {
        log('×©×•××¨ FCM token ×‘×©×¨×ª...', 'info');
        try {
            const response = await fetch('https://localhost:7065/api/Notifications/SaveFCMToken', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${window.currentUser.id}&fcmToken=${window.lastGeneratedToken}`
            });
            
            if (response.ok) {
                log('âœ… Token × ×©××¨ ×‘×”×¦×œ×—×” ×‘×©×¨×ª', 'success');
            } else {
                log(`âŒ ×©××™×¨×ª Token × ×›×©×œ×”: ${response.status}`, 'error');
            }
        } catch (error) {
            log(`âŒ ×©×’×™××” ×‘×©××™×¨×ª Token: ${error.message}`, 'error');
        }
    }
}

async function testServerConnection() {
    log('×‘×•×“×§ ×—×™×‘×•×¨ ×œ×©×¨×ª...', 'info');
    try {
        const response = await fetch('https://localhost:7065/api/Notifications/status');
        if (response.ok) {
            const data = await response.json();
            log(`âœ… ×©×¨×ª ×¤×•×¢×œ: ${data.status} (DB: ${data.database})`, 'success');
        } else {
            log(`âŒ ×©×¨×ª ×”×—×–×™×¨ ×©×’×™××”: ${response.status}`, 'error');
        }
    } catch (error) {
        log(`âŒ ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª: ${error.message}`, 'error');
    }
}

// ××ª×—×•×œ ×¨××©×•× ×™
document.addEventListener('DOMContentLoaded', function() {
    log('××¢×¨×›×ª ×‘×“×™×§×•×ª ×”×ª×¨××•×ª ××•×›× ×” ğŸš€', 'success');
    
    // ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×©×œ ×§×•× ×¤×™×’×•×¨×¦×™×”
    if (typeof firebaseConfig !== 'undefined') {
        log(`Firebase ×¤×¨×•×™×§×˜: ${firebaseConfig.projectId}`, 'info');
    }
    
    if (typeof vapidKey !== 'undefined') {
        log(`VAPID Key ××•×¨×š: ${vapidKey.length} ×ª×•×•×™×`, 'info');
    }
});
</script>

</body>
</html>
