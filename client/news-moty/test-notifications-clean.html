<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔔 בדיקת מערכת התראות</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card { 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .btn { 
            margin: 5px; 
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #debug-info { 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 10px;
            background: #f8f9fa;
        }
        .result-box {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            background: #f0f8ff;
            margin: 10px 0;
        }
        .emoji { font-size: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header text-center bg-primary text-white">
                    <h1>🔔 מערכת התראות - מרכז בדיקות מתקדם</h1>
                    <p class="mb-0">כל הכלים לאבחון ותיקון בעיות Firebase Cloud Messaging</p>
                </div>
                
                <div class="card-body">
                    <!-- בדיקות Firebase מתקדמות -->
                    <div class="mb-4">
                        <h5 class="text-primary">🔍 בדיקות Firebase מתקדמות</h5>
                        <button class="btn btn-primary" onclick="runCompleteFirebaseCheck()">
                            <span class="emoji">🎯</span> בדיקה מלאה של Firebase
                        </button>
                        <button class="btn btn-info" onclick="fullFirebaseProjectCheck()">
                            <span class="emoji">📋</span> בדיקת הגדרות פרויקט
                        </button>
                        <button class="btn btn-warning" onclick="checkServiceWorkerConfig()">
                            <span class="emoji">🔧</span> בדיקת Service Worker
                        </button>
                        <button class="btn btn-success" onclick="checkLocalServer()">
                            <span class="emoji">🌐</span> בדיקת שרת מקומי
                        </button>
                    </div>

                    <!-- תוצאות בדיקות -->
                    <div id="firebase-check-result" class="result-box" style="display: none;">
                        <h6>📊 תוצאות בדיקות:</h6>
                    </div>

                    <hr>

                    <!-- בדיקות בסיסיות -->
                    <div class="mb-4">
                        <h5 class="text-secondary">🧪 בדיקות בסיסיות</h5>
                        <button class="btn btn-outline-primary" onclick="testFirebaseConfig()">
                            <span class="emoji">⚙️</span> בדיקת קונפיגורציה
                        </button>
                        <button class="btn btn-outline-secondary" onclick="testPermissions()">
                            <span class="emoji">🔒</span> בדיקת הרשאות
                        </button>
                        <button class="btn btn-outline-success" onclick="testGetToken()">
                            <span class="emoji">🔑</span> קבלת FCM Token
                        </button>
                        <button class="btn btn-outline-warning" onclick="testSaveToken()">
                            <span class="emoji">💾</span> שמירת Token
                        </button>
                        <button class="btn btn-outline-info" onclick="testServerConnection()">
                            <span class="emoji">🔗</span> חיבור לשרת
                        </button>
                    </div>

                    <hr>

                    <!-- שחזור מערכת -->
                    <div class="mb-4">
                        <h5 class="text-success">🏥 שחזור מערכת</h5>
                        <button class="btn btn-success" onclick="recoverNotificationSystem()">
                            <span class="emoji">🔄</span> שחזור מלא של המערכת
                        </button>
                        <button class="btn btn-info" onclick="showNotificationButtonImmediate()">
                            <span class="emoji">🔔</span> הצגת כפתור פעמון
                        </button>
                        <button class="btn btn-warning" onclick="if(window.currentUser) sendTestNotification(window.currentUser.id)">
                            <span class="emoji">📧</span> שליחת התראת בדיקה
                        </button>
                    </div>

                    <hr>

                    <!-- לוג מערכת -->
                    <div class="mb-4">
                        <h5 class="text-dark">📋 לוג מערכת</h5>
                        <div id="debug-info"></div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="clearDebugInfo()">
                                <span class="emoji">🗑️</span> נקה לוג
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyDebugInfo()">
                                <span class="emoji">📋</span> העתק לוג
                            </button>
                        </div>
                    </div>

                    <!-- מידע מערכת -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6>ℹ️ מידע מערכת:</h6>
                        <small class="text-muted">
                            • Firebase SDK Version: 12.0.0<br>
                            • Service Worker: firebase-messaging-sw.js<br>
                            • Server: localhost:7065<br>
                            • Current User: <span id="current-user-info">לא מוגדר</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- כל הסקריפטים הנדרשים -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/shared/initServerUrl.js"></script>
<script src="js/shared/data.js"></script>
<script src="js/shared/ajaxCalls.js"></script>
<script src="js/firebaseConfig.js"></script>
<script src="js/notifications.js"></script>
<script src="js/notification-recovery.js"></script>
<script src="js/firebase-advanced-check.js"></script>

<script>
// הגדרת משתמש בדיקה
window.currentUser = { id: 1, name: "Test User" };
document.getElementById('current-user-info').textContent = window.currentUser.name;

// פונקציית לוג משופרת
function log(message, type = 'info') {
    const debugInfo = document.getElementById('debug-info');
    const timestamp = new Date().toLocaleTimeString('he-IL');
    const alertClass = {
        'info': 'alert-info',
        'success': 'alert-success', 
        'warning': 'alert-warning',
        'error': 'alert-danger'
    }[type] || 'alert-info';
    
    debugInfo.innerHTML += `<div class="alert ${alertClass} mb-1">
        <small class="text-muted">[${timestamp}]</small> ${message}
    </div>`;
    debugInfo.scrollTop = debugInfo.scrollHeight;
    console.log(`[${timestamp}] ${message}`);
}

// פונקציות עזר
function clearDebugInfo() {
    document.getElementById('debug-info').innerHTML = '';
    log('לוג נוקה', 'info');
}

function copyDebugInfo() {
    const debugInfo = document.getElementById('debug-info').innerText;
    navigator.clipboard.writeText(debugInfo).then(() => {
        log('לוג הועתק ללוח', 'success');
    });
}

// הצגת תוצאות בדיקות
function showCheckResults() {
    const resultDiv = document.getElementById('firebase-check-result');
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth' });
}

// אתחול Firebase לבדיקות
async function initFirebaseForTesting() {
    if (typeof firebaseConfig !== 'undefined') {
        try {
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js');
            window.app = initializeApp(firebaseConfig);
            log('Firebase אותחל בהצלחה לבדיקות', 'success');
            return true;
        } catch (error) {
            log(`שגיאה באתחול Firebase: ${error.message}`, 'error');
            return false;
        }
    } else {
        log('קונפיגורציית Firebase לא נמצאה', 'error');
        return false;
    }
}

// הוספת פונקציות override לבדיקות חדשות
const originalRunCompleteCheck = window.runCompleteFirebaseCheck;
window.runCompleteFirebaseCheck = async function() {
    showCheckResults();
    log('מתחיל בדיקה מלאה של Firebase...', 'info');
    const result = await originalRunCompleteCheck();
    if (result) {
        log('✅ כל הבדיקות עברו בהצלחה!', 'success');
    } else {
        log('❌ יש בעיות שצריכות תיקון', 'error');
    }
    return result;
};

const originalCheckServer = window.checkLocalServer;
window.checkLocalServer = async function() {
    showCheckResults();
    log('בודק חיבור לשרת מקומי...', 'info');
    const result = await originalCheckServer();
    if (result) {
        log('✅ השרת פועל תקין', 'success');
    } else {
        log('❌ בעיה בחיבור לשרת', 'error');
    }
    return result;
};

// פונקציות בדיקה בסיסיות מקוריות
function testFirebaseConfig() {
    log('בודק קונפיגורציית Firebase...', 'info');
    if (typeof firebaseConfig !== 'undefined') {
        log(`✅ Firebase config נמצא - פרויקט: ${firebaseConfig.projectId}`, 'success');
    } else {
        log('❌ Firebase config לא נמצא', 'error');
    }
}

function testPermissions() {
    log('בודק הרשאות דפדפן...', 'info');
    if ('Notification' in window) {
        const permission = Notification.permission;
        log(`הרשאת התראות: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        if (permission === 'default') {
            Notification.requestPermission().then(result => {
                log(`תוצאת בקשת הרשאה: ${result}`, result === 'granted' ? 'success' : 'error');
            });
        }
    } else {
        log('❌ התראות לא נתמכות בדפדפן זה', 'error');
    }
}

async function testGetToken() {
    log('מנסה לקבל FCM token...', 'info');
    try {
        if (!window.app) {
            await initFirebaseForTesting();
        }
        
        const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-messaging.js');
        const messaging = getMessaging(window.app);
        
        if (typeof vapidKey !== 'undefined') {
            const token = await getToken(messaging, { vapidKey: vapidKey });
            if (token) {
                log(`✅ FCM Token התקבל: ${token.substring(0, 30)}...`, 'success');
                window.lastGeneratedToken = token;
            } else {
                log('❌ לא התקבל FCM Token', 'error');
            }
        } else {
            log('❌ VAPID Key לא נמצא', 'error');
        }
    } catch (error) {
        log(`❌ שגיאה בקבלת Token: ${error.message}`, 'error');
    }
}

async function testSaveToken() {
    if (!window.lastGeneratedToken) {
        log('קודם צריך לקבל Token', 'warning');
        await testGetToken();
    }
    
    if (window.lastGeneratedToken) {
        log('שומר FCM token בשרת...', 'info');
        try {
            const response = await fetch('https://localhost:7065/api/Notifications/SaveFCMToken', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `userId=${window.currentUser.id}&fcmToken=${window.lastGeneratedToken}`
            });
            
            if (response.ok) {
                log('✅ Token נשמר בהצלחה בשרת', 'success');
            } else {
                log(`❌ שמירת Token נכשלה: ${response.status}`, 'error');
            }
        } catch (error) {
            log(`❌ שגיאה בשמירת Token: ${error.message}`, 'error');
        }
    }
}

async function testServerConnection() {
    log('בודק חיבור לשרת...', 'info');
    try {
        const response = await fetch('https://localhost:7065/api/Notifications/status');
        if (response.ok) {
            const data = await response.json();
            log(`✅ שרת פועל: ${data.status} (DB: ${data.database})`, 'success');
        } else {
            log(`❌ שרת החזיר שגיאה: ${response.status}`, 'error');
        }
    } catch (error) {
        log(`❌ לא ניתן להתחבר לשרת: ${error.message}`, 'error');
    }
}

// אתחול ראשוני
document.addEventListener('DOMContentLoaded', function() {
    log('מערכת בדיקות התראות מוכנה 🚀', 'success');
    
    // בדיקה אוטומטית של קונפיגורציה
    if (typeof firebaseConfig !== 'undefined') {
        log(`Firebase פרויקט: ${firebaseConfig.projectId}`, 'info');
    }
    
    if (typeof vapidKey !== 'undefined') {
        log(`VAPID Key אורך: ${vapidKey.length} תווים`, 'info');
    }
});
</script>

</body>
</html>
