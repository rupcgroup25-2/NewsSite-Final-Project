<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔬 בדיקת התראות תגובות</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f7fa;
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            margin: 15px 0; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            margin: 8px; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: #0056b3; 
            transform: translateY(-2px);
        }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        button.danger { background: #dc3545; }
        
        .log { 
            background: #f8f9fa; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
            padding: 15px; 
            max-height: 500px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.4;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        
        .result-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🔬 מעבדת בדיקת התראות תגובות</h1>
        <p>כלי מתקדם לאבחון בעיות בהתראות על תגובות חדשות</p>
    </div>

    <div class="card">
        <h3>📊 בדיקת נמענים להתראות</h3>
        <div class="form-group">
            <label>מזהה מאמר:</label>
            <input type="number" id="articleId" value="1" min="1">
            <label>להחריג משתמש:</label>
            <input type="number" id="excludeUserId" value="0" min="0">
            <button onclick="checkNotificationRecipients()">🔍 בדוק נמענים</button>
        </div>
        
        <div id="recipientsResult"></div>
    </div>

    <div class="card">
        <h3>🧪 בדיקת שליחת התראת תגובה</h3>
        <div class="form-group">
            <label>מזהה מאמר:</label>
            <input type="number" id="testArticleId" value="1" min="1">
        </div>
        <div class="form-group">
            <label>כותרת מאמר:</label>
            <input type="text" id="testArticleTitle" value="מאמר לדוגמה" style="width: 200px;">
        </div>
        <div class="form-group">
            <label>מזהה מגיב:</label>
            <input type="number" id="testCommenterId" value="1021" min="1">
        </div>
        <div class="form-group">
            <label>שם המגיב:</label>
            <input type="text" id="testCommenterName" value="רובי" style="width: 150px;">
        </div>
        <button onclick="testCommentNotification()">📤 בדוק שליחת התראה</button>
    </div>

    <div class="card">
        <h3>🛠️ כלי אבחון מתקדמים</h3>
        <button onclick="checkFCMTokens()">🔑 בדוק FCM Tokens</button>
        <button onclick="checkFCMAnalysis()">🔍 ניתוח FCM מפורט</button>
        <button onclick="checkServerConnection()">🌐 בדוק חיבור לשרת</button>
        <button onclick="checkDatabaseTables()">💾 בדוק טבלאות DB</button>
        <button onclick="simulateCommentScenario()">🎭 סימולציית תרחיש מלא</button>
    </div>

    <div class="card">
        <h3>📋 תוצאות ולוגים</h3>
        <button onclick="clearLog()">🗑️ נקה לוג</button>
        <button onclick="exportLog()">📄 ייצא לוג</button>
        <div id="log" class="log"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        const serverUrl = 'https://localhost:7065/api/';
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const className = type;
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('לוג נוקה', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comment-notifications-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('לוג יוצא לקובץ', 'success');
        }

        // בדיקת נמענים להתראות
        async function checkNotificationRecipients() {
            const articleId = document.getElementById('articleId').value;
            const excludeUserId = document.getElementById('excludeUserId').value;
            
            log(`🔍 בודק נמענים להתראות עבור מאמר ${articleId} (החרגת משתמש ${excludeUserId})`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/notification-recipients/${articleId}?excludeUserId=${excludeUserId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ נתונים התקבלו בהצלחה`, 'success');
                    
                    displayRecipientsResult(data);
                } else {
                    const errorText = await response.text();
                    log(`❌ שגיאה בקבלת נתונים: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`❌ שגיאה בחיבור: ${error.message}`, 'error');
            }
        }

        function displayRecipientsResult(data) {
            const resultDiv = document.getElementById('recipientsResult');
            
            const html = `
                <h4>📊 תוצאות בדיקת נמענים:</h4>
                <table class="result-table">
                    <tr><th>פרמטר</th><th>ערך</th></tr>
                    <tr><td>מזהה מאמר</td><td>${data.articleId}</td></tr>
                    <tr><td>משתמש מוחרג</td><td>${data.excludeUserId}</td></tr>
                    <tr><td>כמות נמענים להתראה</td><td><strong>${data.totalNotificationRecipients}</strong></td></tr>
                    <tr><td>כמות תגובות כללי</td><td>${data.totalCommentsOnArticle}</td></tr>
                </table>
                
                <h5>👥 משתמשים שיקבלו התראות:</h5>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                    ${data.usersWhoWillReceiveNotifications.length > 0 ? 
                        data.usersWhoWillReceiveNotifications.map(userId => `<span style="background: #2196F3; color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; display: inline-block;">משתמש ${userId}</span>`).join(' ') :
                        '<span style="color: #666;">אין נמענים</span>'
                    }
                </div>
                
                <h5>💬 כל התגובות על המאמר:</h5>
                <table class="result-table">
                    <tr><th>משתמש</th><th>תוכן תגובה</th><th>תאריך</th></tr>
                    ${data.allCommentsOnArticle.map(comment => `
                        <tr>
                            <td>משתמש ${comment.userId}</td>
                            <td>${comment.commentText}</td>
                            <td>${new Date(comment.date).toLocaleString('he-IL')}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
            
            resultDiv.innerHTML = html;
            
            log(`📊 מאמר ${data.articleId}: ${data.totalNotificationRecipients} נמענים, ${data.totalCommentsOnArticle} תגובות`, 'info');
            log(`👥 נמענים: ${data.usersWhoWillReceiveNotifications.join(', ') || 'אין'}`, 'info');
        }

        // בדיקת שליחת התראת תגובה
        async function testCommentNotification() {
            const articleId = document.getElementById('testArticleId').value;
            const articleTitle = document.getElementById('testArticleTitle').value;
            const commenterId = document.getElementById('testCommenterId').value;
            const commenterName = document.getElementById('testCommenterName').value;
            
            log(`📤 בודק שליחת התראת תגובה...`, 'info');
            log(`📋 פרטים: מאמר ${articleId}, מגיב ${commenterId} (${commenterName})`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/test-comment-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        articleId: parseInt(articleId),
                        articleTitle: articleTitle,
                        commenterId: parseInt(commenterId),
                        commenterName: commenterName
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`✅ התראת בדיקה נשלחה בהצלחה!`, 'success');
                    log(`📋 פרטי תגובה: ${JSON.stringify(result)}`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`❌ שליחת התראה נכשלה: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`❌ שגיאה בשליחת התראת בדיקה: ${error.message}`, 'error');
            }
        }

        // בדיקת FCM Tokens
        async function checkFCMTokens() {
            log(`🔑 בודק סטטוס FCM Tokens...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Notifications/status`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ שרת פועל: ${data.status}, DB: ${data.database}`, 'success');
                } else {
                    log(`❌ בעיה בשרת: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ לא ניתן להתחבר לשרת: ${error.message}`, 'error');
            }
        }

        // ניתוח מפורט של FCM Tokens למשתמשים שהגיבו
        async function checkFCMAnalysis() {
            const articleId = document.getElementById('articleId').value;
            const excludeUserId = document.getElementById('excludeUserId').value;
            
            if (!articleId) {
                log(`❌ יש להזין מספר מאמר`, 'error');
                return;
            }
            
            log(`🔍 מבצע ניתוח FCM מפורט למאמר ${articleId}...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/fcm-analysis/${articleId}?excludeUserId=${excludeUserId}`);
                
                if (response.ok) {
                    const analysis = await response.json();
                    
                    log(`📊 תוצאות ניתוח FCM:`, 'success');
                    log(`   כלל המגיבים: ${analysis.totalCommenters}`, 'info');
                    log(`   מגיבים (ללא הכותב): ${analysis.commentersExcludingRequester}`, 'info');
                    log(`   מגיבים עם FCM Token: ${analysis.commentersWithFCMTokens}`, 'info');
                    
                    if (analysis.fcmAnalysis && analysis.fcmAnalysis.length > 0) {
                        log(`\n📋 פירוט לפי משתמש:`, 'info');
                        analysis.fcmAnalysis.forEach(user => {
                            const status = user.hasFCMToken ? '✅' : '❌';
                            const notification = user.willReceiveNotification ? 'יקבל' : 'לא יקבל';
                            log(`   משתמש ${user.userId}: ${status} Token (${notification} התראה)`, 'info');
                        });
                    }
                    
                    if (analysis.commentersWithFCMTokens === 0) {
                        log(`⚠️ אף מגיב לא יקבל התראה כי אין להם FCM Token פעיל!`, 'warning');
                    }
                    
                } else {
                    log(`❌ שגיאה בבדיקת FCM Analysis: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ שגיאה בחיבור: ${error.message}`, 'error');
            }
        }

        // בדיקת חיבור לשרת
        async function checkServerConnection() {
            log(`🌐 בודק חיבור לשרת...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/article/1`);
                
                if (response.ok) {
                    const comments = await response.json();
                    log(`✅ חיבור לשרת תקין, נמצאו ${comments.length} תגובות במאמר 1`, 'success');
                } else {
                    log(`⚠️ שרת החזיר: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`❌ שגיאת חיבור: ${error.message}`, 'error');
            }
        }

        // בדיקת טבלאות DB
        async function checkDatabaseTables() {
            log(`💾 בודק טבלאות מסד נתונים...`, 'info');
            
            // בדוק תגובות על מאמר מספר 1
            await checkNotificationRecipients();
            
            log(`📊 בדיקת מסד נתונים הושלמה - ראה תוצאות בטבלה למעלה`, 'info');
        }

        // סימולציית תרחיש מלא
        async function simulateCommentScenario() {
            log(`🎭 מתחיל סימולציית תרחיש מלא...`, 'info');
            
            // שלב 1: בדוק נמענים נוכחיים
            log(`1️⃣ בודק מצב התחלתי...`, 'info');
            await checkNotificationRecipients();
            
            // שלב 2: שלח התראת בדיקה
            log(`2️⃣ שולח התראת בדיקה...`, 'info');
            await testCommentNotification();
            
            // שלב 3: בדוק שרת
            log(`3️⃣ בודק סטטוס שרת...`, 'info');
            await checkServerConnection();
            
            log(`🎯 סימולציה הושלמה! בדוק את הלוגים למעלה לתוצאות`, 'success');
        }

        // אתחול
        document.addEventListener('DOMContentLoaded', function() {
            log('🔬 מעבדת בדיקת התראות תגובות מוכנה!', 'success');
            log('💡 התחל עם "בדוק נמענים" כדי לראות מי אמור לקבל התראות', 'info');
        });
    </script>
</body>
</html>
