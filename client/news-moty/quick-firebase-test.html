<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ×‘×“×™×§×” ××”×™×¨×” - Firebase FCM</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin: 10px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ”§ ×‘×“×™×§×” ××”×™×¨×” ×©×œ Firebase FCM</h1>
        <p>×‘×“×™×§×” ××”×™×¨×” ×©×œ ×”×ª×™×§×•× ×™× ×©×‘×™×¦×¢× ×•</p>
        
        <div>
            <button onclick="testBasicSetup()">1ï¸âƒ£ ×‘×“×™×§×ª ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª</button>
            <button onclick="testServiceWorker()">2ï¸âƒ£ ×‘×“×™×§×ª Service Worker ×”×—×“×©</button>
            <button onclick="testFirebaseInit()">3ï¸âƒ£ ×‘×“×™×§×ª ××ª×—×•×œ Firebase</button>
            <button onclick="testTokenGeneration()">4ï¸âƒ£ ×‘×“×™×§×ª ×™×¦×™×¨×ª Token</button>
            <button onclick="testServerConnection()">5ï¸âƒ£ ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×©×¨×ª</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š ×ª×•×¦××•×ª ×‘×“×™×§×•×ª:</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- ×˜×¢×™× ×ª ×›×œ ×”×¡×§×¨×™×¤×˜×™× ×”× ×“×¨×©×™× -->
    <script src="js/shared/initServerUrl.js"></script>
    <script src="js/shared/data.js"></script>
    <script src="js/shared/ajaxCalls.js"></script>
    <script src="js/firebaseConfig.js"></script>

    <script>
        // ×”×’×“×¨×ª ××©×ª××© ×œ×‘×“×™×§×”
        window.currentUser = { id: 1021, name: "rubi", email: "rubi@gmail.com" };
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const className = type;
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('×œ×•×’ × ×•×§×”', 'info');
        }

        // 1. ×‘×“×™×§×ª ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª
        function testBasicSetup() {
            log('ğŸ§ª ××ª×—×™×œ ×‘×“×™×§×ª ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª...', 'info');
            
            // ×‘×“×™×§×ª Firebase Config
            if (typeof firebaseConfig !== 'undefined') {
                log(`âœ… Firebase Config × ××¦× - ×¤×¨×•×™×§×˜: ${firebaseConfig.projectId}`, 'success');
            } else {
                log('âŒ Firebase Config ×œ× × ××¦×', 'error');
                return false;
            }

            // ×‘×“×™×§×ª VAPID Key
            if (typeof vapidKey !== 'undefined') {
                log(`âœ… VAPID Key × ××¦× - ××•×¨×š: ${vapidKey.length} ×ª×•×•×™×`, 'success');
                log(`ğŸ“ VAPID Key ××ª×—×™×œ ×‘: ${vapidKey.substring(0, 10)}...`, 'info');
            } else {
                log('âŒ VAPID Key ×œ× × ××¦×', 'error');
            }

            // ×‘×“×™×§×ª ×ª××™×›×ª ×“×¤×“×¤×Ÿ
            if ('serviceWorker' in navigator) {
                log('âœ… Service Worker × ×ª××š ×‘×“×¤×“×¤×Ÿ', 'success');
            } else {
                log('âŒ Service Worker ×œ× × ×ª××š ×‘×“×¤×“×¤×Ÿ', 'error');
            }

            if ('Notification' in window) {
                log(`âœ… Notifications × ×ª××›×•×ª - ×¡×˜×˜×•×¡: ${Notification.permission}`, 'success');
            } else {
                log('âŒ Notifications ×œ× × ×ª××›×•×ª ×‘×“×¤×“×¤×Ÿ', 'error');
            }

            log('ğŸ¯ ×‘×“×™×§×ª ×”×’×“×¨×•×ª ×‘×¡×™×¡×™×•×ª ×”×•×©×œ××”', 'info');
        }

        // 2. ×‘×“×™×§×ª Service Worker ×”×—×“×©
        async function testServiceWorker() {
            log('ğŸ”§ ×‘×•×“×§ Service Worker ×”×—×“×©...', 'info');
            
            try {
                // ×‘×˜×œ ×¨×™×©×•× ×©×œ service workers ×™×©× ×™×
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    log(`ğŸ”„ ××‘×˜×œ ×¨×™×©×•× Service Worker: ${registration.scope}`, 'warning');
                    await registration.unregister();
                }

                // ×¨×©× Service Worker ×—×“×©
                log('ğŸ“ ×¨×•×©× Service Worker ×—×“×©...', 'info');
                const registration = await navigator.serviceWorker.register('./firebase-messaging-sw-v12.js', {
                    scope: '/firebase-cloud-messaging-push-scope'
                });

                log('âœ… Service Worker × ×¨×©× ×‘×”×¦×œ×—×”', 'success');
                log(`ğŸ“ Scope: ${registration.scope}`, 'info');

                // ×—×›×” ×©-Service Worker ×™×”×™×” ××•×›×Ÿ
                await navigator.serviceWorker.ready;
                log('ğŸŸ¢ Service Worker ××•×›×Ÿ ×œ×©×™××•×©', 'success');

                return registration;
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘-Service Worker: ${error.message}`, 'error');
                return null;
            }
        }

        // 3. ×‘×“×™×§×ª ××ª×—×•×œ Firebase
        async function testFirebaseInit() {
            log('ğŸ”¥ ×‘×•×“×§ ××ª×—×•×œ Firebase...', 'info');
            
            try {
                if (typeof firebaseConfig === 'undefined') {
                    throw new Error('Firebase Config ×œ× × ××¦×');
                }

                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js');
                window.app = initializeApp(firebaseConfig);
                
                log('âœ… Firebase ××•×ª×—×œ ×‘×”×¦×œ×—×”', 'success');
                log(`ğŸ“ App name: ${window.app.name}`, 'info');
                log(`ğŸ“ Project ID: ${window.app.options.projectId}`, 'info');

                return window.app;
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘××ª×—×•×œ Firebase: ${error.message}`, 'error');
                return null;
            }
        }

        // 4. ×‘×“×™×§×ª ×™×¦×™×¨×ª Token
        async function testTokenGeneration() {
            log('ğŸ”‘ ×‘×•×“×§ ×™×¦×™×¨×ª FCM Token...', 'info');
            
            try {
                // ×•×“× ×©Firebase ×××•×ª×—×œ
                if (!window.app) {
                    log('ğŸ”¥ ×××ª×—×œ Firebase ×§×•×“×...', 'warning');
                    await testFirebaseInit();
                }

                // ×•×“× ×©Service Worker ×¨×©×•×
                const registration = await testServiceWorker();
                if (!registration) {
                    throw new Error('Service Worker ×œ× ×–××™×Ÿ');
                }

                // ×§×‘×œ ×”×¨×©××•×ª
                if (Notification.permission === 'default') {
                    log('ğŸ”’ ××‘×§×© ×”×¨×©××•×ª ×”×ª×¨××•×ª...', 'warning');
                    const permission = await Notification.requestPermission();
                    log(`ğŸ“ ×ª×•×¦××ª ×”×¨×©××”: ${permission}`, permission === 'granted' ? 'success' : 'error');
                }

                // ×™×¦×•×¨ Token
                const { getMessaging, getToken } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-messaging.js');
                const messaging = getMessaging(window.app);

                log('ğŸ¯ ××™×™×¦×¨ FCM Token ×¢× VAPID Key...', 'info');
                
                let token;
                if (typeof vapidKey !== 'undefined') {
                    token = await getToken(messaging, { 
                        vapidKey: vapidKey,
                        serviceWorkerRegistration: registration
                    });
                } else {
                    token = await getToken(messaging, {
                        serviceWorkerRegistration: registration
                    });
                }

                if (token) {
                    log('âœ… FCM Token × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
                    log(`ğŸ“§ Token (×—×œ×§×™): ${token.substring(0, 50)}...`, 'info');
                    log(`ğŸ“ ××•×¨×š Token: ${token.length} ×ª×•×•×™×`, 'info');
                    
                    window.testFCMToken = token;
                    return token;
                } else {
                    throw new Error('×œ× ×”×ª×§×‘×œ Token');
                }

            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª Token: ${error.message}`, 'error');
                if (error.code) {
                    log(`ğŸ“‹ ×§×•×“ ×©×’×™××”: ${error.code}`, 'error');
                }
                return null;
            }
        }

        // 5. ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×©×¨×ª
        async function testServerConnection() {
            log('ğŸŒ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×©×¨×ª...', 'info');
            
            try {
                // ×‘×“×•×§ ×¡×˜×˜×•×¡ ×”×©×¨×ª
                log('ğŸ“¡ ×‘×•×“×§ ×¡×˜×˜×•×¡ ×”×©×¨×ª...', 'info');
                const statusResponse = await fetch('https://localhost:7065/api/Notifications/status');
                
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    log(`âœ… ×©×¨×ª ×¤×•×¢×œ: ${statusData.status}`, 'success');
                    log(`ğŸ’¾ ××¡×“ × ×ª×•× ×™×: ${statusData.database}`, statusData.database === 'connected' ? 'success' : 'warning');
                } else {
                    log(`âš ï¸ ×©×¨×ª ×”×—×–×™×¨ ×©×’×™××”: ${statusResponse.status}`, 'warning');
                }

                // × ×¡×” ×œ×©××•×¨ Token (×× ×™×©)
                if (window.testFCMToken) {
                    log('ğŸ’¾ ×× ×¡×” ×œ×©××•×¨ FCM Token ×‘×©×¨×ª...', 'info');
                    
                    const saveResponse = await fetch('https://localhost:7065/api/Notifications/SaveFCMToken', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `userId=${window.currentUser.id}&fcmToken=${encodeURIComponent(window.testFCMToken)}`
                    });

                    if (saveResponse.ok) {
                        log('âœ… FCM Token × ×©××¨ ×‘×”×¦×œ×—×” ×‘×©×¨×ª!', 'success');
                    } else {
                        const errorText = await saveResponse.text();
                        log(`âŒ ×©××™×¨×ª Token × ×›×©×œ×”: ${saveResponse.status} - ${errorText}`, 'error');
                    }
                } else {
                    log('âš ï¸ ××™×Ÿ FCM Token ×œ×©××™×¨×” - ×¨×¥ ×§×•×“× ×‘×“×™×§×ª ×™×¦×™×¨×ª Token', 'warning');
                }

            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª: ${error.message}`, 'error');
                log('ğŸ’¡ ×•×“× ×©×”×©×¨×ª ×¨×¥ ×¢×œ: https://localhost:7065', 'info');
            }
        }

        // ××ª×—×•×œ ××•×˜×•××˜×™
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ××¢×¨×›×ª ×‘×“×™×§×ª Firebase FCM ××•×›× ×”!', 'success');
            log('ğŸ’¡ ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨×™× ×›×“×™ ×œ×‘×¦×¢ ×‘×“×™×§×•×ª', 'info');
        });

    </script>
</body>
</html>
