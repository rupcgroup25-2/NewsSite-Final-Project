<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Notification Diagnostic Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="bi bi-bug"></i> Firebase Notification Diagnostic Tool</h3>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            This tool will diagnose and attempt to fix Firebase notification issues.
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <button id="runDiagnostics" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Run Comprehensive Diagnostics
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="testNotification" class="btn btn-success w-100">
                                    <i class="bi bi-bell"></i> Test Notification
                                </button>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3">
                                <button id="cleanupTokens" class="btn btn-warning w-100">
                                    <i class="bi bi-trash"></i> Cleanup Invalid Tokens
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="getTokenStats" class="btn btn-info w-100">
                                    <i class="bi bi-graph-up"></i> Token Statistics
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="resetNotifications" class="btn btn-secondary w-100">
                                    <i class="bi bi-arrow-clockwise"></i> Reset Notifications
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button id="serverDiagnosis" class="btn btn-danger w-100">
                                    <i class="bi bi-server"></i> Server Diagnosis
                                </button>
                            </div>
                        </div>

                        <div id="results" class="mt-4"></div>
                        <div id="logs" class="mt-4">
                            <h5>Console Logs:</h5>
                            <div id="logOutput" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Firebase config and notification system -->
    <script src="js/firebaseConfig.js"></script>
    <script src="js/shared/ajaxCalls.js"></script>
    <script src="js/shared/initServerUrl.js"></script>
    <script src="js/notifications.js"></script>

    <script>
        // Mock current user for testing
        window.currentUser = { id: 1, email: 'test@test.com' };

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(type, ...args) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.join(' ');
            const colorClass = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-success';
            logOutput.innerHTML += `<div class="${colorClass}">[${timestamp}] ${type.toUpperCase()}: ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('log', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('error', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('warn', ...args);
        };

        // Wait for dependencies to load
        function waitForDependencies() {
            if (typeof firebaseConfig === 'undefined' || typeof ajaxCall === 'undefined' || typeof serverUrl === 'undefined') {
                setTimeout(waitForDependencies, 100);
                return;
            }
            
            console.log('✅ All dependencies loaded');
            document.getElementById('runDiagnostics').disabled = false;
            document.getElementById('testNotification').disabled = false;
            document.getElementById('cleanupTokens').disabled = false;
            document.getElementById('getTokenStats').disabled = false;
            document.getElementById('resetNotifications').disabled = false;
            document.getElementById('serverDiagnosis').disabled = false;
        }

        function showResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const alertClass = `alert-${type}`;
            results.innerHTML = `
                <div class="alert ${alertClass}">
                    <h5>${title}</h5>
                    ${content}
                </div>
            `;
        }

        // Button event handlers
        document.getElementById('runDiagnostics').addEventListener('click', async function() {
            this.disabled = true;
            showResult('Running Diagnostics...', 'Please wait while we check your Firebase notification setup.');
            
            try {
                if (typeof window.diagnoseAndFixNotifications === 'function') {
                    const result = await window.diagnoseAndFixNotifications();
                    
                    let content = '<h6>Issues Found:</h6><ul>';
                    result.issues.forEach(issue => {
                        content += `<li class="text-danger">${issue}</li>`;
                    });
                    content += '</ul><h6>Fixes Applied:</h6><ul>';
                    result.fixes.forEach(fix => {
                        content += `<li class="text-success">${fix}</li>`;
                    });
                    content += '</ul>';
                    
                    const type = result.issues.length === 0 ? 'success' : (result.canRecover ? 'warning' : 'danger');
                    showResult('Diagnostic Results', content, type);
                } else {
                    showResult('Error', 'Diagnostic function not available. Make sure notifications.js is loaded.', 'danger');
                }
            } catch (error) {
                showResult('Error', `Diagnostic failed: ${error.message}`, 'danger');
            } finally {
                this.disabled = false;
            }
        });

        document.getElementById('testNotification').addEventListener('click', function() {
            this.disabled = true;
            showResult('Testing Notification...', 'Sending test notification to server.');
            
            ajaxCall(
                "POST",
                serverUrl + "Notifications/TestNotification",
                JSON.stringify({
                    userId: window.currentUser.id,
                    title: "Test Notification",
                    message: "This is a test notification from the diagnostic tool"
                }),
                (response) => {
                    showResult('Test Notification', 'Test notification sent successfully!', 'success');
                    this.disabled = false;
                },
                (xhr) => {
                    showResult('Test Notification Failed', `Error: ${xhr.responseText}`, 'danger');
                    this.disabled = false;
                }
            );
        });

        document.getElementById('cleanupTokens').addEventListener('click', function() {
            this.disabled = true;
            showResult('Cleaning Up Tokens...', 'Removing invalid FCM tokens from database.');
            
            ajaxCall(
                "POST",
                serverUrl + "Notifications/CleanupInvalidTokens",
                "",
                (response) => {
                    const data = JSON.parse(response);
                    showResult('Token Cleanup Complete', `Removed ${data.tokensRemoved} invalid tokens.`, 'success');
                    this.disabled = false;
                },
                (xhr) => {
                    showResult('Token Cleanup Failed', `Error: ${xhr.responseText}`, 'danger');
                    this.disabled = false;
                }
            );
        });

        document.getElementById('getTokenStats').addEventListener('click', function() {
            this.disabled = true;
            
            ajaxCall(
                "GET",
                serverUrl + "Notifications/GetTokenStats",
                "",
                (response) => {
                    const stats = JSON.parse(response);
                    const content = `
                        <div class="row">
                            <div class="col-md-3"><strong>Total Tokens:</strong> ${stats.totalTokens}</div>
                            <div class="col-md-3"><strong>Active Tokens:</strong> ${stats.activeTokens}</div>
                            <div class="col-md-3"><strong>Enabled Tokens:</strong> ${stats.enabledTokens}</div>
                            <div class="col-md-3"><strong>Users with Tokens:</strong> ${stats.usersWithTokens}</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6"><strong>Inactive Tokens:</strong> ${stats.inactiveTokens}</div>
                            <div class="col-md-6"><strong>Disabled Tokens:</strong> ${stats.disabledTokens}</div>
                        </div>
                    `;
                    showResult('Token Statistics', content, 'info');
                    this.disabled = false;
                },
                (xhr) => {
                    showResult('Statistics Failed', `Error: ${xhr.responseText}`, 'danger');
                    this.disabled = false;
                }
            );
        });

        document.getElementById('resetNotifications').addEventListener('click', async function() {
            this.disabled = true;
            showResult('Resetting Notifications...', 'Clearing browser data and re-initializing notifications.');
            
            try {
                // Clear current state
                window.currentFCMToken = null;
                window.notificationsInitialized = false;
                
                // Unregister all service workers
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
                
                // Wait and re-initialize
                setTimeout(async () => {
                    try {
                        await window.initializeNotifications();
                        showResult('Reset Complete', 'Notifications have been reset and re-initialized.', 'success');
                    } catch (error) {
                        showResult('Reset Failed', `Error during re-initialization: ${error.message}`, 'danger');
                    }
                    this.disabled = false;
                }, 1000);
                
            } catch (error) {
                showResult('Reset Failed', `Error: ${error.message}`, 'danger');
                this.disabled = false;
            }
        });

        document.getElementById('serverDiagnosis').addEventListener('click', function() {
            this.disabled = true;
            showResult('Running Server Diagnosis...', 'Getting comprehensive FCM diagnosis from server.');
            
            ajaxCall(
                "GET",
                serverUrl + "Notifications/GetComprehensiveDiagnosis",
                "",
                (response) => {
                    const diagnosis = JSON.parse(response);
                    
                    let content = `
                        <div class="mb-3">
                            <h6><i class="bi bi-clock"></i> Diagnosis Time:</h6>
                            <small class="text-muted">${diagnosis.timestamp}</small>
                        </div>
                        
                        <div class="mb-3">
                            <h6><i class="bi bi-database"></i> Project Info:</h6>
                            <p><strong>Project ID:</strong> ${diagnosis.projectId}</p>
                        </div>`;
                    
                    if (diagnosis.issues && diagnosis.issues.length > 0) {
                        content += `
                            <div class="mb-3">
                                <h6><i class="bi bi-exclamation-triangle text-danger"></i> Issues Found:</h6>
                                <ul class="list-group list-group-flush">`;
                        diagnosis.issues.forEach(issue => {
                            content += `<li class="list-group-item text-danger">${issue}</li>`;
                        });
                        content += `</ul></div>`;
                    }
                    
                    if (diagnosis.solutions && diagnosis.solutions.length > 0) {
                        content += `
                            <div class="mb-3">
                                <h6><i class="bi bi-tools text-success"></i> Solutions:</h6>
                                <ul class="list-group list-group-flush">`;
                        diagnosis.solutions.forEach(solution => {
                            if (solution.includes('http')) {
                                const url = solution.split(': ')[1] || solution;
                                const text = solution.split(': ')[0] || solution;
                                content += `<li class="list-group-item"><a href="${url}" target="_blank" class="btn btn-sm btn-outline-primary">${text}</a></li>`;
                            } else {
                                content += `<li class="list-group-item text-success">${solution}</li>`;
                            }
                        });
                        content += `</ul></div>`;
                    }
                    
                    if (diagnosis.quickFixes && diagnosis.quickFixes.length > 0) {
                        content += `
                            <div class="mb-3">
                                <h6><i class="bi bi-lightning text-warning"></i> Quick Fixes:</h6>
                                <ul class="list-group list-group-flush">`;
                        diagnosis.quickFixes.forEach(fix => {
                            content += `<li class="list-group-item text-warning">${fix}</li>`;
                        });
                        content += `</ul></div>`;
                    }
                    
                    if (diagnosis.tokenStats) {
                        const stats = diagnosis.tokenStats;
                        content += `
                            <div class="mb-3">
                                <h6><i class="bi bi-graph-up"></i> Token Statistics:</h6>
                                <div class="row">
                                    <div class="col-md-3"><strong>Total:</strong> ${stats.totalTokens}</div>
                                    <div class="col-md-3"><strong>Active:</strong> ${stats.activeTokens}</div>
                                    <div class="col-md-3"><strong>Enabled:</strong> ${stats.enabledTokens}</div>
                                    <div class="col-md-3"><strong>Users:</strong> ${stats.usersWithTokens}</div>
                                </div>
                            </div>`;
                    }
                    
                    const alertType = diagnosis.issues && diagnosis.issues.length > 0 ? 'danger' : 'success';
                    showResult('🔍 Server Diagnosis Complete', content, alertType);
                    this.disabled = false;
                },
                (xhr) => {
                    showResult('Server Diagnosis Failed', `Error: ${xhr.responseText}`, 'danger');
                    this.disabled = false;
                }
            );
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Disable buttons until dependencies load
            document.getElementById('runDiagnostics').disabled = true;
            document.getElementById('testNotification').disabled = true;
            document.getElementById('cleanupTokens').disabled = true;
            document.getElementById('getTokenStats').disabled = true;
            document.getElementById('resetNotifications').disabled = true;
            document.getElementById('serverDiagnosis').disabled = true;
            document.getElementById('serverDiagnosis').disabled = true;
            
            waitForDependencies();
        });
    </script>
</body>
</html>
