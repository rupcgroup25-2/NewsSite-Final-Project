<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ ×‘×“×™×§×ª ×”×ª×¨××•×ª ×ª×’×•×‘×•×ª</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f7fa;
        }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            margin: 15px 0; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            margin: 8px; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover { 
            background: #0056b3; 
            transform: translateY(-2px);
        }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #212529; }
        button.danger { background: #dc3545; }
        
        .log { 
            background: #f8f9fa; 
            border: 2px solid #dee2e6; 
            border-radius: 8px; 
            padding: 15px; 
            max-height: 500px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.4;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .result-table th, .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        
        .result-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ”¬ ××¢×‘×“×ª ×‘×“×™×§×ª ×”×ª×¨××•×ª ×ª×’×•×‘×•×ª</h1>
        <p>×›×œ×™ ××ª×§×“× ×œ××‘×—×•×Ÿ ×‘×¢×™×•×ª ×‘×”×ª×¨××•×ª ×¢×œ ×ª×’×•×‘×•×ª ×—×“×©×•×ª</p>
    </div>

    <div class="card">
        <h3>ğŸ“Š ×‘×“×™×§×ª × ××¢× ×™× ×œ×”×ª×¨××•×ª</h3>
        <div class="form-group">
            <label>××–×”×” ××××¨:</label>
            <input type="number" id="articleId" value="1" min="1">
            <label>×œ×”×—×¨×™×’ ××©×ª××©:</label>
            <input type="number" id="excludeUserId" value="0" min="0">
            <button onclick="checkNotificationRecipients()">ğŸ” ×‘×“×•×§ × ××¢× ×™×</button>
        </div>
        
        <div id="recipientsResult"></div>
    </div>

    <div class="card">
        <h3>ğŸ§ª ×‘×“×™×§×ª ×©×œ×™×—×ª ×”×ª×¨××ª ×ª×’×•×‘×”</h3>
        <div class="form-group">
            <label>××–×”×” ××××¨:</label>
            <input type="number" id="testArticleId" value="1" min="1">
        </div>
        <div class="form-group">
            <label>×›×•×ª×¨×ª ××××¨:</label>
            <input type="text" id="testArticleTitle" value="××××¨ ×œ×“×•×’××”" style="width: 200px;">
        </div>
        <div class="form-group">
            <label>××–×”×” ××’×™×‘:</label>
            <input type="number" id="testCommenterId" value="1021" min="1">
        </div>
        <div class="form-group">
            <label>×©× ×”××’×™×‘:</label>
            <input type="text" id="testCommenterName" value="×¨×•×‘×™" style="width: 150px;">
        </div>
        <button onclick="testCommentNotification()">ğŸ“¤ ×‘×“×•×§ ×©×œ×™×—×ª ×”×ª×¨××”</button>
    </div>

    <div class="card">
        <h3>ğŸ› ï¸ ×›×œ×™ ××‘×—×•×Ÿ ××ª×§×“××™×</h3>
        <button onclick="checkFCMTokens()">ğŸ”‘ ×‘×“×•×§ FCM Tokens</button>
        <button onclick="checkFCMAnalysis()">ğŸ” × ×™×ª×•×— FCM ××¤×•×¨×˜</button>
        <button onclick="checkServerConnection()">ğŸŒ ×‘×“×•×§ ×—×™×‘×•×¨ ×œ×©×¨×ª</button>
        <button onclick="checkDatabaseTables()">ğŸ’¾ ×‘×“×•×§ ×˜×‘×œ××•×ª DB</button>
        <button onclick="simulateCommentScenario()">ğŸ­ ×¡×™××•×œ×¦×™×™×ª ×ª×¨×—×™×© ××œ×</button>
    </div>

    <div class="card">
        <h3>ğŸ“‹ ×ª×•×¦××•×ª ×•×œ×•×’×™×</h3>
        <button onclick="clearLog()">ğŸ—‘ï¸ × ×§×” ×œ×•×’</button>
        <button onclick="exportLog()">ğŸ“„ ×™×™×¦× ×œ×•×’</button>
        <div id="log" class="log"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        const serverUrl = 'https://localhost:7065/api/';
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('he-IL');
            const className = type;
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('×œ×•×’ × ×•×§×”', 'info');
        }

        function exportLog() {
            const logContent = document.getElementById('log').innerText;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comment-notifications-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('×œ×•×’ ×™×•×¦× ×œ×§×•×‘×¥', 'success');
        }

        // ×‘×“×™×§×ª × ××¢× ×™× ×œ×”×ª×¨××•×ª
        async function checkNotificationRecipients() {
            const articleId = document.getElementById('articleId').value;
            const excludeUserId = document.getElementById('excludeUserId').value;
            
            log(`ğŸ” ×‘×•×“×§ × ××¢× ×™× ×œ×”×ª×¨××•×ª ×¢×‘×•×¨ ××××¨ ${articleId} (×”×—×¨×’×ª ××©×ª××© ${excludeUserId})`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/notification-recipients/${articleId}?excludeUserId=${excludeUserId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… × ×ª×•× ×™× ×”×ª×§×‘×œ×• ×‘×”×¦×œ×—×”`, 'success');
                    
                    displayRecipientsResult(data);
                } else {
                    const errorText = await response.text();
                    log(`âŒ ×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™×: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×—×™×‘×•×¨: ${error.message}`, 'error');
            }
        }

        function displayRecipientsResult(data) {
            const resultDiv = document.getElementById('recipientsResult');
            
            const html = `
                <h4>ğŸ“Š ×ª×•×¦××•×ª ×‘×“×™×§×ª × ××¢× ×™×:</h4>
                <table class="result-table">
                    <tr><th>×¤×¨××˜×¨</th><th>×¢×¨×š</th></tr>
                    <tr><td>××–×”×” ××××¨</td><td>${data.articleId}</td></tr>
                    <tr><td>××©×ª××© ××•×—×¨×’</td><td>${data.excludeUserId}</td></tr>
                    <tr><td>×›××•×ª × ××¢× ×™× ×œ×”×ª×¨××”</td><td><strong>${data.totalNotificationRecipients}</strong></td></tr>
                    <tr><td>×›××•×ª ×ª×’×•×‘×•×ª ×›×œ×œ×™</td><td>${data.totalCommentsOnArticle}</td></tr>
                </table>
                
                <h5>ğŸ‘¥ ××©×ª××©×™× ×©×™×§×‘×œ×• ×”×ª×¨××•×ª:</h5>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 5px;">
                    ${data.usersWhoWillReceiveNotifications.length > 0 ? 
                        data.usersWhoWillReceiveNotifications.map(userId => `<span style="background: #2196F3; color: white; padding: 5px 10px; margin: 2px; border-radius: 15px; display: inline-block;">××©×ª××© ${userId}</span>`).join(' ') :
                        '<span style="color: #666;">××™×Ÿ × ××¢× ×™×</span>'
                    }
                </div>
                
                <h5>ğŸ’¬ ×›×œ ×”×ª×’×•×‘×•×ª ×¢×œ ×”××××¨:</h5>
                <table class="result-table">
                    <tr><th>××©×ª××©</th><th>×ª×•×›×Ÿ ×ª×’×•×‘×”</th><th>×ª××¨×™×š</th></tr>
                    ${data.allCommentsOnArticle.map(comment => `
                        <tr>
                            <td>××©×ª××© ${comment.userId}</td>
                            <td>${comment.commentText}</td>
                            <td>${new Date(comment.date).toLocaleString('he-IL')}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
            
            resultDiv.innerHTML = html;
            
            log(`ğŸ“Š ××××¨ ${data.articleId}: ${data.totalNotificationRecipients} × ××¢× ×™×, ${data.totalCommentsOnArticle} ×ª×’×•×‘×•×ª`, 'info');
            log(`ğŸ‘¥ × ××¢× ×™×: ${data.usersWhoWillReceiveNotifications.join(', ') || '××™×Ÿ'}`, 'info');
        }

        // ×‘×“×™×§×ª ×©×œ×™×—×ª ×”×ª×¨××ª ×ª×’×•×‘×”
        async function testCommentNotification() {
            const articleId = document.getElementById('testArticleId').value;
            const articleTitle = document.getElementById('testArticleTitle').value;
            const commenterId = document.getElementById('testCommenterId').value;
            const commenterName = document.getElementById('testCommenterName').value;
            
            log(`ğŸ“¤ ×‘×•×“×§ ×©×œ×™×—×ª ×”×ª×¨××ª ×ª×’×•×‘×”...`, 'info');
            log(`ğŸ“‹ ×¤×¨×˜×™×: ××××¨ ${articleId}, ××’×™×‘ ${commenterId} (${commenterName})`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/test-comment-notification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        articleId: parseInt(articleId),
                        articleTitle: articleTitle,
                        commenterId: parseInt(commenterId),
                        commenterName: commenterName
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`âœ… ×”×ª×¨××ª ×‘×“×™×§×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!`, 'success');
                    log(`ğŸ“‹ ×¤×¨×˜×™ ×ª×’×•×‘×”: ${JSON.stringify(result)}`, 'info');
                } else {
                    const errorText = await response.text();
                    log(`âŒ ×©×œ×™×—×ª ×”×ª×¨××” × ×›×©×œ×”: ${response.status} - ${errorText}`, 'error');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×¨××ª ×‘×“×™×§×”: ${error.message}`, 'error');
            }
        }

        // ×‘×“×™×§×ª FCM Tokens
        async function checkFCMTokens() {
            log(`ğŸ”‘ ×‘×•×“×§ ×¡×˜×˜×•×¡ FCM Tokens...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Notifications/status`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… ×©×¨×ª ×¤×•×¢×œ: ${data.status}, DB: ${data.database}`, 'success');
                } else {
                    log(`âŒ ×‘×¢×™×” ×‘×©×¨×ª: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª: ${error.message}`, 'error');
            }
        }

        // × ×™×ª×•×— ××¤×•×¨×˜ ×©×œ FCM Tokens ×œ××©×ª××©×™× ×©×”×’×™×‘×•
        async function checkFCMAnalysis() {
            const articleId = document.getElementById('articleId').value;
            const excludeUserId = document.getElementById('excludeUserId').value;
            
            if (!articleId) {
                log(`âŒ ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ××××¨`, 'error');
                return;
            }
            
            log(`ğŸ” ××‘×¦×¢ × ×™×ª×•×— FCM ××¤×•×¨×˜ ×œ××××¨ ${articleId}...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/debug/fcm-analysis/${articleId}?excludeUserId=${excludeUserId}`);
                
                if (response.ok) {
                    const analysis = await response.json();
                    
                    log(`ğŸ“Š ×ª×•×¦××•×ª × ×™×ª×•×— FCM:`, 'success');
                    log(`   ×›×œ×œ ×”××’×™×‘×™×: ${analysis.totalCommenters}`, 'info');
                    log(`   ××’×™×‘×™× (×œ×œ× ×”×›×•×ª×‘): ${analysis.commentersExcludingRequester}`, 'info');
                    log(`   ××’×™×‘×™× ×¢× FCM Token: ${analysis.commentersWithFCMTokens}`, 'info');
                    
                    if (analysis.fcmAnalysis && analysis.fcmAnalysis.length > 0) {
                        log(`\nğŸ“‹ ×¤×™×¨×•×˜ ×œ×¤×™ ××©×ª××©:`, 'info');
                        analysis.fcmAnalysis.forEach(user => {
                            const status = user.hasFCMToken ? 'âœ…' : 'âŒ';
                            const notification = user.willReceiveNotification ? '×™×§×‘×œ' : '×œ× ×™×§×‘×œ';
                            log(`   ××©×ª××© ${user.userId}: ${status} Token (${notification} ×”×ª×¨××”)`, 'info');
                        });
                    }
                    
                    if (analysis.commentersWithFCMTokens === 0) {
                        log(`âš ï¸ ××£ ××’×™×‘ ×œ× ×™×§×‘×œ ×”×ª×¨××” ×›×™ ××™×Ÿ ×œ×”× FCM Token ×¤×¢×™×œ!`, 'warning');
                    }
                    
                } else {
                    log(`âŒ ×©×’×™××” ×‘×‘×“×™×§×ª FCM Analysis: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××” ×‘×—×™×‘×•×¨: ${error.message}`, 'error');
            }
        }

        // ×‘×“×™×§×ª ×—×™×‘×•×¨ ×œ×©×¨×ª
        async function checkServerConnection() {
            log(`ğŸŒ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ×©×¨×ª...`, 'info');
            
            try {
                const response = await fetch(`${serverUrl}Comments/article/1`);
                
                if (response.ok) {
                    const comments = await response.json();
                    log(`âœ… ×—×™×‘×•×¨ ×œ×©×¨×ª ×ª×§×™×Ÿ, × ××¦××• ${comments.length} ×ª×’×•×‘×•×ª ×‘××××¨ 1`, 'success');
                } else {
                    log(`âš ï¸ ×©×¨×ª ×”×—×–×™×¨: ${response.status}`, 'warning');
                }
            } catch (error) {
                log(`âŒ ×©×’×™××ª ×—×™×‘×•×¨: ${error.message}`, 'error');
            }
        }

        // ×‘×“×™×§×ª ×˜×‘×œ××•×ª DB
        async function checkDatabaseTables() {
            log(`ğŸ’¾ ×‘×•×“×§ ×˜×‘×œ××•×ª ××¡×“ × ×ª×•× ×™×...`, 'info');
            
            // ×‘×“×•×§ ×ª×’×•×‘×•×ª ×¢×œ ××××¨ ××¡×¤×¨ 1
            await checkNotificationRecipients();
            
            log(`ğŸ“Š ×‘×“×™×§×ª ××¡×“ × ×ª×•× ×™× ×”×•×©×œ××” - ×¨××” ×ª×•×¦××•×ª ×‘×˜×‘×œ×” ×œ××¢×œ×”`, 'info');
        }

        // ×¡×™××•×œ×¦×™×™×ª ×ª×¨×—×™×© ××œ×
        async function simulateCommentScenario() {
            log(`ğŸ­ ××ª×—×™×œ ×¡×™××•×œ×¦×™×™×ª ×ª×¨×—×™×© ××œ×...`, 'info');
            
            // ×©×œ×‘ 1: ×‘×“×•×§ × ××¢× ×™× × ×•×›×—×™×™×
            log(`1ï¸âƒ£ ×‘×•×“×§ ××¦×‘ ×”×ª×—×œ×ª×™...`, 'info');
            await checkNotificationRecipients();
            
            // ×©×œ×‘ 2: ×©×œ×— ×”×ª×¨××ª ×‘×“×™×§×”
            log(`2ï¸âƒ£ ×©×•×œ×— ×”×ª×¨××ª ×‘×“×™×§×”...`, 'info');
            await testCommentNotification();
            
            // ×©×œ×‘ 3: ×‘×“×•×§ ×©×¨×ª
            log(`3ï¸âƒ£ ×‘×•×“×§ ×¡×˜×˜×•×¡ ×©×¨×ª...`, 'info');
            await checkServerConnection();
            
            log(`ğŸ¯ ×¡×™××•×œ×¦×™×” ×”×•×©×œ××”! ×‘×“×•×§ ××ª ×”×œ×•×’×™× ×œ××¢×œ×” ×œ×ª×•×¦××•×ª`, 'success');
        }

        // ××ª×—×•×œ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”¬ ××¢×‘×“×ª ×‘×“×™×§×ª ×”×ª×¨××•×ª ×ª×’×•×‘×•×ª ××•×›× ×”!', 'success');
            log('ğŸ’¡ ×”×ª×—×œ ×¢× "×‘×“×•×§ × ××¢× ×™×" ×›×“×™ ×œ×¨××•×ª ××™ ×××•×¨ ×œ×§×‘×œ ×”×ª×¨××•×ª', 'info');
        });
    </script>
</body>
</html>
